<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Device History</title>
        <style>
            body {
                background-color: #121212;
                color: #ffffff;
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
            }

            /* Header */
            .header {
                position: relative;
                background-color: #1e1e1e;
                padding: 20px;
                text-align: center;
                height: 60px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                z-index: 2;
            }
            .header .left {
                float: left;
                display: flex;
                align-items: center;
            }
            .header .left h1 {
                margin: 0;
            }
            .header .right {
                float: right;
            }
            .history-button {
                background-color: #1b1b1d;
                border: 1px solid #2f3031;
                color: #ffffff;
                border-radius: 8px;
                padding: 10px 20px;
                cursor: pointer;
                transition: opacity 0.3s ease;
            }
            .history-button:hover {
                opacity: 0.8;
            }
            .history-button:active {
                opacity: 0.6;
            }

            /* Main container */
            .container {
                display: flex;
                flex-direction: column;
                padding: 20px;
            }

            /* Minute block styling */
            .minute-block {
                margin-bottom: 40px;
            }
            .minute-heading {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 10px;
            }
            .minute-title {
                margin: 0;
                font-size: 1.2em;
                font-weight: normal;
            }

            /* Table styling */
            .entries-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }
            .entries-table th,
            .entries-table td {
                border: 1px solid #333;
                padding: 10px;
                text-align: left;
            }
            .entries-table th {
                background-color: #1b1b1d;
            }
            .entries-table td {
                background-color: #1e1e1e;
            }

            /* LED dot for "on"/"off" states */
            .mini_led {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                display: inline-block;
                background-color: #121212;
                margin-left: 5px;
            }
            .mini_led.on {
                background-color: #1f67aa;
                box-shadow: 0px 0px 50px 0px #1f67aaa8;
            }

            /* Message container (flash messages) */
            .message-container {
                position: relative;
                text-align: center;
                margin-top: 20px;
                justify-content: center;
                align-items: center;
                width: 100%;
                max-height: 100px;
                transition: max-height 0.5s ease;
                overflow: hidden; 
            }
            .message-container.height-zero {
                max-height: 0;
            }
            .message-container #message {
                z-index: 1;
                position: relative;
                padding: 10px;
                margin: 10px;
                border-radius: 8px;
                display: inline-block;
                width: fit-content;
                transition: transform 0.5s ease, opacity 0.5s ease,
                            margin 0.5s ease, padding 0.5s ease;
            }
            .message-container #message.move-up {
                transform: translate(0%, -200px); 
                opacity: 0;
            }
            .message-container .success {
                background-color: #4CAF5088;
                border: #2eca33 1px solid;
            }
            .message-container .error {
                background-color: #f4433688; 
                border: #ff2a1b 1px solid;
            }

            /* Overlay for adding a new device (optional) */
            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                justify-content: center;
                align-items: center;
            }
            .overlay-content {
                background-color: #1e1e1e;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
            }
            .overlay-content input, .overlay-content select {
                margin: 10px 0;
                padding: 10px;
                width: 80%;
            }
            .overlay-content button {
                padding: 10px 20px;
                margin: 10px;
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <div class="header">
            <div class="left">
                <h1>Device History</h1>
            </div>
            <div class="right">
                <!-- Example button that could refresh page or go back, etc. -->
                <button class="history-button" onclick="location.reload()">Refresh</button>
            </div>
        </div>
        
        <!-- Flash messages -->
        <div class="message-container" id="message-container">
            {% with messages = get_flashed_messages(with_categories=True) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div id="message" class="{{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <!-- Main content -->
        <div class="container">
            <!--
              history_by_minute is expected to be a dict or OrderedDict with
              keys like "2025-01-09 10:23" and values as a list of device rows:
              
              {
                  "2025-01-09 10:23": [
                      {
                          "device_id": 2,
                          "devicename": "test3",
                          "roomID": 1,
                          "state": 1
                      },
                      {
                          "device_id": 3,
                          "devicename": "test_light_01",
                          "roomID": 1,
                          "state": 1
                      }
                  ],
                  "2025-01-08 08:24": [ ... ],
                  ...
              }
            -->
            {% for minute, entries in history_by_minute.items() %}
                <div class="minute-block">
                    <div class="minute-heading">
                        <h2 class="minute-title">
                            {{ minute }}
                        </h2>
                    </div>
                    <table class="entries-table">
                        <thead>
                            <tr>
                                <th>Device Name</th>
                                <th>Device ID</th>
                                <th>Room ID</th>
                                <th>State</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in entries %}
                                <tr>
                                    <td>{{ entry.devicename }}</td>
                                    <td>{{ entry.device_id }}</td>
                                    <td>{{ entry.roomID }}</td>
                                    <td>
                                        {{ entry.state }}
                                        <span class="mini_led {% if entry.state == 'on' or entry.state == 1 %}on{% endif %}"></span>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endfor %}
        </div>

        <!-- Optional overlay form: Add Device -->
        <div class="overlay" id="overlay">
            <div class="overlay-content">
                <h2>Add Device</h2>
                <form action="/add-device" method="post" onsubmit="return handleFormSubmit()">
                    <input type="text" name="deviceName" placeholder="Device Name" required>
                    <input type="number" name="pin" placeholder="PIN Number" required>
                    <input type="number" name="roomID" placeholder="Room ID" required>
                    <select name="deviceType" required>
                        <option value="" disabled selected>Select Device Type</option>
                        <option value="output">Light</option>
                        <option value="input">Switch</option>
                    </select>
                    <br>
                    <button type="submit">Confirm</button>
                    <button type="button" onclick="closeOverlay()">Cancel</button>
                </form>
            </div>
        </div>
    
        <script>
            function openOverlay() {
                document.getElementById('overlay').style.display = 'flex';
            }
            function closeOverlay() {
                document.getElementById('overlay').style.display = 'none';
            }
            function handleFormSubmit() {
                closeOverlay();
                return true; // Allow form submission
            }
            function closeMessage() {
                const messageContainer = document.getElementById('message');
                document.getElementById('message-container').classList.add('height-zero');
                if (messageContainer) {
                    messageContainer.classList.add('move-up');
                    setTimeout(function () {
                        messageContainer.style.border = 'none';
                    }, 500);
                }
            }
            // Close flash messages after 5 seconds
            setTimeout(closeMessage, 5000);
        </script>
    </body>
</html>
